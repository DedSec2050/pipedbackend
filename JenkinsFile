pipeline {
    agent any
    environment {
        APP_DIR = "/home/ubuntu/pipedbackend"
        REPO_URL = "https://github.com/DedSec2050/pipedbackend.git"
        BRANCH = "master"
        VENV_DIR = "${APP_DIR}/venv"
    }
    
    stages {
        stage('Stop Service') {
            steps {
                sh 'sudo systemctl stop flaskapp || true'
            }
        }

        stage('Pull Code') {
            steps {
                sh '''
                    sudo mkdir -p ${APP_DIR}
                    sudo chown -R jenkins:jenkins ${APP_DIR}
                '''
                dir("${APP_DIR}") {
                    git branch: "${BRANCH}", url: "${REPO_URL}"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                sh """
                    cd ${APP_DIR}
                    python3 -m venv ${VENV_DIR}
                    ${VENV_DIR}/bin/pip install --upgrade pip
                    ${VENV_DIR}/bin/pip install -r requirements.txt
                """
            }
        }

        stage('Start Service') {
            steps {
                sh 'sudo systemctl daemon-reload'
                sh 'sudo systemctl start flaskapp'
            }
        }
    }
}
